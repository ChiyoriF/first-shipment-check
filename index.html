<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å‡ºè·ç•°å¸¸ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€æ–°æœˆ vs éå»6ã‹æœˆï¼‰</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 900px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: right;
    }

    th {
      background-color: #f0f0f0;
      text-align: center;
    }

    td:nth-child(2),
    td:nth-child(3) {
      text-align: left;
    }

    .highlight {
      background-color: #fff3a0;
    }
  </style>
</head>
<body>

<h2>ğŸ“¦ å‡ºè·ç•°å¸¸ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€æ–°æœˆ vs éå»6ã‹æœˆå¹³å‡ï¼‰</h2>

<p>
  <label>å‡ºè·å®Ÿç¸¾CSVï¼ˆæœˆåˆ¥æ¨ªæŒã¡ï¼‰ï¼š</label><br>
  <input type="file" id="csvFile">
</p>

<p>
  <label>
    è­¦å‘Šã—ãã„å€¤ï¼š
    <input type="number" id="threshold" value="30" style="width:60px;"> %
  </label>
</p>

<p>
  <label>
    æœ€ä½å‡ºè·æ•°é‡ï¼ˆcsï¼‰ï¼š
    <input type="number" id="minQty" value="10" style="width:60px;">
  </label>
</p>

<button onclick="process()">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>

<div id="result"></div>

<p style="color:#555; font-size:14px;">
  â€» æœ€æ–°æœˆã¨ç›´å‰6ã‹æœˆå¹³å‡ã‚’æ¯”è¼ƒã—ã¾ã™<br>
  â€» CSVã¯ UTF-8 ã§ä¿å­˜ã—ã¦ãã ã•ã„
</p>

<script>
/* ---------- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---------- */

function toNumber(v) {
  return Number(
    String(v)
      .replace(/,/g, "")
      .replace(/ã€€/g, "")
      .trim()
  );
}

function normalizeKey(s) {
  return String(s)
    .replace(/ã€€/g, "")
    .replace(/\s+/g, "")
    .trim();
}

/* æœˆåˆ—ã‚’å¹´æœˆé †ã§å–å¾— */
function getSortedMonthColumns(row) {
  return Object.keys(row)
    .filter(k => /\d{2}å¹´\d{2}æœˆåº¦/.test(k))
    .sort((a, b) => {
      const [ay, am] = a.match(/\d+/g).map(Number);
      const [by, bm] = b.match(/\d+/g).map(Number);
      return ay !== by ? ay - by : am - bm;
    });
}

/* ---------- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºå‡¦ç† ---------- */

function renderTableFromSingleCSV(data) {
  const threshold = Number(document.getElementById("threshold").value) / 100;

const minQty = Number(document.getElementById("minQty").value);

  let html = `
    <table>
      <tr>
        <th>è­¦å‘Šç¨®åˆ¥</th>
        <th>å•†å“å</th>
        <th>å¾—æ„å…ˆå</th>
        <th>æœ€æ–°æœˆå‡ºè·</th>
        <th>éå»6ã‹æœˆå¹³å‡</th>
        <th>è¶…éç‡</th>
      </tr>
  `;

  let hasWarning = false;

  data.forEach(r => {
    const product  = normalizeKey(r["å•†å“å"]);
    const customer = normalizeKey(r["å¾—æ„å…ˆå"]);

    if (!product || !customer) return;

    const months = getSortedMonthColumns(r);
    if (months.length < 2) return;

    const latestCol = months[months.length - 1];
    const pastCols  = months.slice(-7, -1); // ç›´å‰6ã‹æœˆ

    const latestQty = toNumber(r[latestCol]);
if (isNaN(latestQty) || latestQty < minQty) return;


    let total = 0;
    let count = 0;

    pastCols.forEach(c => {
      const v = toNumber(r[c]);
      if (!isNaN(v)) {
        total += v;
        count++;
      }
    });

    /* åˆå‡ºè· */
    if (count === 0 && latestQty > 0) {
      hasWarning = true;
      html += `
        <tr class="highlight">
          <td>âš  åˆå‡ºè·</td>
          <td>${product}</td>
          <td>${customer}</td>
          <td>${latestQty}</td>
          <td>â€•</td>
          <td>â€•</td>
        </tr>
      `;
      return;
    }

    if (count === 0) return;

    const avg = total / count;
    const rate = (latestQty - avg) / avg;

    /* æ€¥å¢— */
    if (rate > threshold) {
      hasWarning = true;
      html += `
        <tr class="highlight">
          <td>âš  æ€¥å¢—</td>
          <td>${product}</td>
          <td>${customer}</td>
          <td>${latestQty}</td>
          <td>${avg.toFixed(1)}</td>
          <td>${Math.round(rate * 100)}%</td>
        </tr>
      `;
    }
  });

  html += "</table>";

  document.getElementById("result").innerHTML =
    hasWarning ? html : "<p>âš  è­¦å‘Šå¯¾è±¡ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
}

/* ---------- CSVèª­è¾¼ ---------- */

function process() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) {
    alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  Papa.parse(file, {
    header: true,
    complete: function(result) {
      renderTableFromSingleCSV(result.data);
    }
  });
}
</script>

</body>
</html>
