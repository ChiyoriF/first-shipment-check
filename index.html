<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å‡ºè·ç•°å¸¸ãƒã‚§ãƒƒã‚¯ï¼ˆéå»6ã‹æœˆæ¯”ï¼‰</title>

  <!-- CSVãƒ‘ãƒ¼ã‚µ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }

    h2 {
      margin-bottom: 10px;
    }

    label {
      font-weight: bold;
    }

    table {
      border-collapse: collapse;
      margin-top: 20px;
      min-width: 800px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: right;
    }

    th {
      background-color: #f0f0f0;
      text-align: center;
    }

    td:first-child,
    td:nth-child(2) {
      text-align: left;
    }

    .highlight {
      background-color: #fff3a0;
    }

    .note {
      margin-top: 15px;
      color: #555;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2>ğŸ“¦ å‡ºè·ç•°å¸¸ãƒã‚§ãƒƒã‚¯ï¼ˆéå»6ã‹æœˆå¹³å‡æ¯”ï¼‰</h2>

  <p>
    <label>â‘  éå»6ã‹æœˆ å‡ºè·å®Ÿç¸¾CSVï¼š</label><br>
    <input type="file" id="historyCsv">
  </p>

  <p>
    <label>â‘¡ ä»Šæœˆ å‡ºè·å®Ÿç¸¾CSVï¼š</label><br>
    <input type="file" id="currentCsv">
  </p>

  <p>
    <label>
      è­¦å‘Šã—ãã„å€¤ï¼š
      <input type="number" id="threshold" value="30" style="width:60px;"> %
    </label>
  </p>

  <button onclick="process()">ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>

  <div id="result"></div>

  <p class="note">
    â€» éå»6ã‹æœˆå¹³å‡ã‚ˆã‚ŠæŒ‡å®šï¼…ä»¥ä¸Šå¤šã„å‡ºè·ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™<br>
    â€» CSVã¯ UTF-8 ã§ä¿å­˜ã—ã¦ãã ã•ã„
  </p>

<script>
/* æœˆåˆ¥åˆ—ï¼ˆâ—¯å¹´â—¯æœˆåº¦ï¼‰ã‚’è‡ªå‹•æŠ½å‡º */
function getMonthColumns(row) {
  return Object.keys(row).filter(k =>
    /\d{2}å¹´\d{2}æœˆåº¦/.test(k)
  );
}

/* éå»6ã‹æœˆã®å¹³å‡ãƒãƒƒãƒ—ä½œæˆ */
function buildAverageMap(historyData) {
  const map = {};

  historyData.forEach(r => {
    const customer = r["å¾—æ„å…ˆå"]?.trim();
    const product = r["å•†å“å"]?.trim();
    if (!customer || !product) return;

    const months = getMonthColumns(r);
    let total = 0;
    let count = 0;

    months.forEach(m => {
      const v = Number(r[m]);
      if (!isNaN(v)) {
        total += v;
        count++;
      }
    });

    if (count === 0) return;

    const key = `${customer}__${product}`;
    map[key] = total / count;
  });

  return map;
}

/* çµæœè¡¨ç¤ºï¼ˆ30ï¼…è¶…ã®ã¿ï¼‰ */
function renderTable(currentData, avgMap) {
  const threshold = Number(document.getElementById("threshold").value) / 100;

  let html = `
    <table>
      <tr>
        <th>å•†å“å</th>
        <th>å¾—æ„å…ˆå</th>
        <th>ä»Šæœˆå‡ºè·</th>
        <th>éå»6ã‹æœˆå¹³å‡</th>
        <th>è¶…éç‡</th>
      </tr>
  `;

  let hasWarning = false;

  currentData.forEach(r => {
    const customer = r["å¾—æ„å…ˆå"]?.trim();
    const product = r["å•†å“å"]?.trim();
    const qty = Number(r["å‡ºè·æ•°é‡"]);

    if (!customer || !product || isNaN(qty)) return;

    const key = `${customer}__${product}`;
    const avg = avgMap[key];

    if (!avg || avg === 0) return;

    const rate = (qty - avg) / avg;

    if (rate > threshold) {
      hasWarning = true;
      html += `
        <tr class="highlight">
          <td>${product}</td>
          <td>${customer}</td>
          <td>${qty}</td>
          <td>${avg.toFixed(1)}</td>
          <td>${Math.round(rate * 100)}%</td>
        </tr>
      `;
    }
  });

  html += "</table>";

  document.getElementById("result").innerHTML =
    hasWarning ? html : "<p>âš  è­¦å‘Šå¯¾è±¡ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
}

/* ãƒ¡ã‚¤ãƒ³å‡¦ç† */
function process() {
  const historyFile = document.getElementById("historyCsv").files[0];
  const currentFile = document.getElementById("currentCsv").files[0];

  if (!historyFile || !currentFile) {
    alert("CSVã‚’2ã¤é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  Papa.parse(historyFile, {
    header: true,
    complete: function(historyResult) {
      const avgMap = buildAverageMap(historyResult.data);

      Papa.parse(currentFile, {
        header: true,
        complete: function(currentResult) {
          renderTable(currentResult.data, avgMap);
        }
      });
    }
  });
}
</script>

</body>
</html>
